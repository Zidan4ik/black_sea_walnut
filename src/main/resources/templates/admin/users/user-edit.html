<!DOCTYPE html>
<html lang="uk"
      layout:decorate="~{admin/blocks/layout.html}"
      xmlns:layout="http://www.w3.org/1999/xhtml"
      xmlns="http://www.w3.org/1999/html">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title th:text="#{text.users}"></title>
    <link rel="stylesheet" th:href="@{/css/tabs-localization.css}"/>
    <link rel="stylesheet" th:href="@{/css/button.css}"/>
    <link rel="stylesheet" th:href="@{/css/icon.css}"/>
    <link rel="stylesheet" th:href="@{/css/text.css}"/>

    <style>
        .user-status-icon {
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.3s ease;
            color: #6c757d;
        }

        .user-status-icon:hover {
            color: #ff5050;
            filter: drop-shadow(0 0 12px rgb(148, 51, 51));
            transform: scale(1.05);
        }

        .user-status-icon i {
            display: inline-block;
            transition: all 0.3s ease;
        }

        .user-status-icon:hover i {
            color: #ff5050;
            transform: scale(1.05);
        }
    </style>
</head>
<body>
<!-- Content -->
<div layout:fragment="content" class="container-xxl d-flex align-items-stretch flex-grow-1 p-0">
    <div class="flex-shrink-1 flex-grow-1 container-p-x container-p-y">

        <!-- Header content -->
        <div class="row">
            <div class="row col-12 d-flex align-items-center mb-3 justify-content-start">
                <div class="col-auto text-center">
                    <a th:href="@{/admin/users}">
                        <i class="ti ti-arrow-left icon-hover-arrow" style="color: green; font-size: 30px;"></i>
                    </a>
                </div>
                <div class="col-auto" style="padding-right: 5px;" th:text="#{text.users}"></div>
                <i class="ti ti-arrow-right col-auto p-0" style="color: grey; font-size: 15px;"></i>
                <div class="col-auto" style="padding-left: 5px;font-weight: bold;" data-text="fullName"></div>
            </div>
            <div class="row">
                <div class="col-auto text-start">
                    <span class="title-out-user" data-text="fullName"></span>
                </div>
                <div class="col-auto d-flex align-items-center p-0">
                    <a class="user-status-icon" type="button" th:data-id="${id}">
                        <i th:classappend="${userStatus != 'isActive'? 'ti-arrow-back-up':'ti-forbid'}"
                           class="ti"></i>
                    </a>
                </div>
                <div class="col d-flex justify-content-end">
                    <input id="registrationType_" class="form-control" type="text" style="width: auto;" disabled>
                </div>
            </div>
        </div>
        <!--/ Header content -->


        <div class="row">
            <div id="header-block-uk"></div>

            <div id="image-block-uk" class="col-12 col-sm-3 mb-3"
                 style="text-align: center;">
                <div class="d-flex flex-column align-items-center ms-1 position-relative"
                     style="flex: 1;">
                    <img id="fileImage" data-name="fileImage"
                         src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQGL-nM5H8eZfM19UQbIgDn0XwOUj1ByAyV4Q&s"
                         alt="error" style="width: 100%; height: 250px; display: block;">
                    <button type="button" data-type="fileImage"
                            class="btn btn-outline-success btn-select"
                            style="width: 80%;margin-top: 10px;" th:text="#{text.button.change}">
                    </button>
                    <a type="button" data-type="fileImage"
                       class="btnTrashMyBefore position-absolute btn-delete" style="right: 5px;padding-top: 5px;">
                        <i class="ti ti-trash" style="font-size: x-large;"></i>
                    </a>
                </div>
                <div class="d-flex flex-column justify-content-center align-items-center"
                     style="flex: 1; text-align: center;">
                                <span style="color: darkgrey; margin-top: 10px;" th:text="#{text.mediaSize5}">
                                </span>
                </div>
            </div>
            <div class="col-12 col-sm-7 mb-3 mt-4">
                <div class="row g-3">
                    <div class="col-6">
                        <h5 th:text="#{text.contactInformation}+':'"></h5>
                        <div>
                            <label for="fullName_" class="form-label bold" th:text="#{table.header.fio}+'*'"></label>
                            <input class="form-control" id="fullName_" type="text" data-name="fullName"
                                   th:placeholder="#{text.fullNamePerson}"/>
                        </div>
                        <div>
                            <label for="phone_" class="form-label bold" th:text="#{table.header.phone}+'*'"></label>
                            <input class="form-control" id="phone_" type="text" data-name="phone"
                                   placeholder="+38067123123"/>
                        </div>
                        <div>
                            <label for="email_" class="form-label bold" th:text="#{table.header.email}+'*'"></label>
                            <input class="form-control" id="email_" type="text" data-name="email"
                                   placeholder="ivanivanov@gmail.com"/>
                        </div>
                    </div>
                    <div class="col-6">
                        <h5 th:text="#{text.addressForDeliveryOnUkraine}+':'"></h5>
                        <div>
                            <label for="region_" class="form-label bold" th:text="#{text.regions}+'*'"></label>
                            <select class="form-select mx-2 select-card-block-spinner ms-0"
                                    id="region_" data-name="regionForDeliveryId">
                                <option th:text="#{text.regions}" value="" selected></option>
                            </select>
                        </div>
                        <div>
                            <label for="city_" class="form-label bold" th:text="#{text.locality}+'*'"></label>
                            <select class="form-select mx-2 select-card-block-spinner ms-0"
                                    id="city_" data-name="cityForDeliveryId" disabled>
                                <option th:text="#{text.cities}" value="" selected></option>
                            </select>
                        </div>
                        <div>
                            <label for="departmentForDelivery_" class="form-label bold"
                                   th:text="#{text.departmentOfNP}+'*'"></label>
                            <input class="form-control" id="departmentForDelivery_" type="text"
                                   data-name="departmentForDelivery"
                                   th:placeholder="#{text.placeholderDepartmentNewPost}"/>
                        </div>
                    </div>
                </div>
                <div class="row g-3" id="container-user-details_" style="display: none">
                    <div class="col-6">
                        <h5 th:text="#{text.props}+':'"></h5>
                        <div id="container-okpo_" style="display: none;">
                            <input class="form-control" id="okpo_" type="text"
                                   data-name="okpo" th:placeholder="#{text.okpo}+'*'"/>
                        </div>
                        <div id="container-edrpou_" style="display: none;">
                            <input class="form-control" id="edrpou_" type="text"
                                   data-name="edrpou" th:placeholder="#{text.erdpou}+'*'"/>
                        </div>
                    </div>
                    <div class="col-6">
                        <h5 id="title-registration_"></h5>
                        <div class="d-flex flex-column gap-2">
                            <div>
                                <select class="form-select mx-2 select-card-block-spinner ms-0"
                                        id="regionAdditionallyId_" data-name="regionAdditionallyId">
                                    <option value="" selected th:text="#{text.regions}+'*'"></option>
                                </select>
                            </div>
                            <div>
                                <select class="form-select mx-2 select-card-block-spinner ms-0"
                                        id="cityAdditionallyId_" data-name="cityAdditionallyId" disabled>
                                    <option value="" selected th:text="#{text.cities}+'*'"></option>
                                </select>
                            </div>
                            <div>
                                <input class="form-control" id="addressAdditionally_" type="text"
                                       data-name="addressAdditionally"
                                       th:placeholder="#{table.header.address}+'*'"/>
                            </div>
                            <div id="container-index_" style="display: none;">
                                <input class="form-control" id="indexLawful_" type="text"
                                       data-name="indexLawful"
                                       th:placeholder="#{text.index}+'*'"/>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="d-flex justify-content-center">
                <button type="button" class="btn btn-green" id="btn-save_" style="width: 25%;"
                        th:text="#{text.button.save}"></button>
            </div>
            <div class="row d-flex justify-content-center mt-5">
                <h4 class="text-center" th:text="#{text.ordersHistory}"></h4>
                <div class="table-responsive" style="overflow-x: auto;">
                    <table class="table table-bordered table-hover"
                           style="table-layout: fixed; position: static; zoom: 1;"
                           id="table-data-container_">
                        <thead>
                        <tr class="table-light">
                            <th style="width: 200px;text-align: center;" th:text="#{table.header.order}"></th>
                            <th style="width: 180px;text-align: center;" th:text="#{table.header.date}"></th>
                            <th style="width: 200px;text-align: center;" th:text="#{table.header.statusOrder}"></th>
                            <th style="width: 200px;text-align: center;" th:text="#{table.header.summa}"></th>
                            <th style="width: 200px;text-align: center;" th:text="#{table.header.statusPayment}"></th>
                            <th style="width: 60px;"></th>
                        </tr>
                        </thead>
                    </table>
                </div>
            </div>
        </div>

        <!-- Hidden Inputs-->
        <input type="hidden" id="id_" th:value="${id}">
        <input type="file" id="file-fileImage" data-type="fileImage" class="files"
               accept="image/*" style="display: none;">
        <input type="hidden" data-name="pathToImage" class="files" data-image="fileImage">
        <!--/ Hidden Inputs-->


        <!-- Modal -->
        <div class="modal fade show" id="ModalForDelete" tabindex="-1" aria-modal="true" role="dialog">
            <div class="modal-dialog modal-dialog-centered modal-md" role="document">
                <div class="modal-content">
                    <div class="modal-header text-center" style="font-size: 20px"
                         th:text="#{text.areYouSureToDeleteProduct}">
                    </div>
                    <div class="modal-footer">
                        <a th:href="@{/admin/product/{id}/delete (id=${id})}" class="btn btn-danger float-end"
                           th:text="#{text.yes}"></a>
                        <button type="button" class="btn btn-secondary float-end" data-bs-dismiss="modal"
                                th:text="#{text.no}">
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <script>
            function deleteButtonTarget() {
                $('#btn-target_').on('click', function () {
                    const modal = new bootstrap.Modal(document.querySelector("#ModalForDelete"));
                    modal.show();
                });
            }
        </script>
        <!--/ Modal -->

        <script th:src="@{/js/image.js}"></script>
        <script th:src="@{/js/validator.js}"></script>
        <script th:src="@{/js/event-listener.js}"></script>
        <script th:src="@{/js/modal.js}"></script>


        <script>
            const inputs = [];
            let timeoutId;
            let userStatus;
            $(document).ready(function () {
                let id = $('#id_').val();
                let pathToTable = `${contextPath}/admin/user/${id}/orders/table/load`;
                requestGetUser(id);

                invokeRequest(pathToTable);
                addEventListenersImage2();
                saveUser();
                selectedLanguage();
            });

            function invokeRequest(path) {
                $("#table-data-container_ tbody").empty();
                clearTimeout(timeoutId);
                timeoutId = setTimeout(() => {
                    htmx.ajax('GET', `${path}`, {
                        target: '#table-data-container_',
                        swap: 'beforeend'
                    });
                }, 1000);
            }

            function saveUser() {
                $(`#btn-save_`).on('click', function () {
                    const url = `${contextPath}/admin/user-${userStatus}/save`;
                    saveRequest(url);
                });
            }
        </script>
        <script>

            async function initLocationSelectors() {
                await getRegions();
                addEventListenerChangeRegion($("#region_"), $("#city_"));
                addEventListenerChangeRegion($("#regionAdditionallyId_"), $("#cityAdditionallyId_"));
            }

            function addEventListenerChangeRegion(elR, elC) {
                elR.on('change', function () {
                    let regionId = $(this).val();
                    const option = elC.find('option:first').prop('outerHTML');
                    elC.html(option);
                    if (!regionId && regionId === '') {
                        elC.prop('disabled', true);
                    } else {
                        elC.prop('disabled', false);
                        getCities(regionId, elC);
                    }
                });
            }

            function getRegions() {
               return $.get(`${contextPath}/admin/regions/get`).done(function (data){
                   fillDataInSelectors(data, $("#regionAdditionallyId_"));
                   fillDataInSelectors(data, $("#region_"));
               });
            }

            function getCities(regionId, elSelector) {
                return $.get(`${contextPath}/admin/cities?regionId=${regionId}`).done(function (data){
                    const firstOption = elSelector.find('option:first').prop('outerHTML');
                    elSelector.html(firstOption);

                    fillDataInSelectors(data, elSelector);
                    elSelector.prop('disabled', false);
                });
            }

            function fillDataInSelectors(arr, elSelector) {
                if (elSelector) {
                    arr.forEach(function (el) {
                        let option = document.createElement("option");
                        option.value = el.id;
                        option.textContent = el.name;
                        elSelector.append(option);
                    });
                }
            }

            function saveRequest(url) {
                let formData = getFormData();
                $.ajax({
                    type: "post",
                    url: url,
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function () {
                        window.location.replace(contextPath + '/admin/users');
                    },
                    error: function (error) {
                        clearValid();
                        let data = JSON.parse(error.responseText);
                        validate2(data);
                        console.log("Error submitting form:", error);
                    }
                });
            }

            function getFormData() {
                const resForm = new FormData();
                resForm.append("id", $('#id_').val());
                resForm.append("fullName", $('#fullName_').val());
                resForm.append('phone', $('#phone_').val());
                resForm.append('email', $('#email_').val());
                let regionId = $('#region_').val();
                if (regionId) {
                    resForm.append('regionForDeliveryId', regionId);
                }

                let cityId = $('#city_').val();
                if (cityId) {
                    resForm.append('cityForDeliveryId', cityId);
                }

                let department = $('#departmentForDelivery_').val();
                if (department) {
                    resForm.append('departmentForDelivery', department);
                }

                resForm.append("pathToImage", $(`input[data-name="pathToImage"]`).val());
                let file = $('#file-fileImage')[0].files[0];
                if (file) {
                    resForm.append('fileImage', file);
                }

                if (userStatus === 'legal' || userStatus === 'fop') {
                    let cityId = $(`#cityAdditionallyId_`).val();
                    let regionId = $(`#regionAdditionallyId_`).val();
                    if (cityId) {
                        resForm.append('cityAdditionallyId', cityId);
                    }
                    if (regionId) {
                        resForm.append('regionAdditionallyId', regionId);
                    }
                    resForm.append('addressAdditionally', $(`#addressAdditionally_`).val());
                    if (userStatus === 'legal') {
                        resForm.append('okpo', $(`#okpo_`).val());
                        resForm.append('indexLawful', $(`#indexLawful_`).val());
                    } else if (userStatus === 'fop') {
                        resForm.append('edrpou', $(`#edrpou_`).val());
                    }
                }
                return resForm;
            }
        </script>

        <script>
            async function requestGetUser(id) {
                let data = await $.get(`${contextPath}/admin/user/${id}`);
                console.log(data);
                userStatus = data.registrationType;
                $(`#registrationType_`).val(returnUserStatus(userStatus));
                if (userStatus === 'legal' || userStatus === 'fop') {
                    if (userStatus === 'legal') {
                        $(`#container-index_`).css("display", 'block');
                        $(`#container-okpo_`).css("display", 'block');
                    } else if (userStatus === 'fop') {
                        $(`#container-edrpou_`).css("display", 'block');
                    }
                    $(`#container-user-details_`).css("display", 'flex');
                    $(`#title-registration_`).text(returnUserStatus(userStatus));
                }
                for (let key in data) {
                    if (data.hasOwnProperty(key)) {
                        if (!data[key]) continue;
                        let input = $(`input[data-name="${key}"], textarea[data-name="${key}"], div[data-name="${key}"], select[data-name="${key}"]`);
                        if (input) {
                            if (input.hasClass('files')) {
                                let img = input.attr('data-image');
                                let $input = $(`#${img}`);
                                if ($input && data[key] !== null) {
                                    $input.attr('src', data[key] === '' ? path_default_image : contextPath + data[key]);
                                    input.val(data[key]);
                                }
                            } else {
                                if (key === 'fullName') {
                                    $(`span[data-text="fullName"]`).text(data[key]);
                                    $(`div[data-text="fullName"]`).text(data[key]);
                                    input.val(data[key]);
                                } else {
                                    input.val(data[key]);
                                }
                            }
                        }
                    }
                }
                await initLocationSelectors();

                if(data.regionForDeliveryId != null && data.cityForDeliveryId !== null){
                    $('#region_').val(data.regionForDeliveryId);
                    await getCities(data.regionForDeliveryId,$('#city_'));
                    $('#city_').val(data.cityForDeliveryId);
                }

                if(data.regionAdditionallyId != null &&  data.cityAdditionallyId !== null){
                    $('#regionAdditionallyId_').val(data.regionAdditionallyId);
                    await getCities(data.regionAdditionallyId,$('#cityAdditionallyId_'));
                    $('#cityAdditionallyId_').val(data.cityAdditionallyId);
                }
            }

            $(document).on('click', '.user-status-icon', function () {
                let id = $(this).attr('data-id');
                $.ajax({
                    type: "POST",
                    url: `${contextPath}/admin/user/${id}/change`,
                    success: function () {
                        window.location.reload();
                    },
                    error: function (error) {
                        console.log("Error submitting form:", error);
                    }
                });
            });
        </script>
    </div>
</div>
<!--/ Content -->
</body>
</html>